<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°</title>
<style>
  body{font-family:sans-serif;margin:0;background:#f5f5f5}
  h1{margin:.5rem 0;text-align:center;font-size:1.2rem}
  .container{display:flex;gap:.8rem;justify-content:center;flex-wrap:wrap;padding:.5rem}
  .table-box{border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.1);padding:.5rem;min-width:220px;display:flex;flex-direction:column;background:#fff}
  .table-header{display:flex;justify-content:space-between;font-weight:700}
  .queue-label{font-size:1.4rem;font-weight:700;text-align:center;margin:.4rem 0}
  .buttons{margin-top:auto;display:flex;gap:.5rem;justify-content:flex-end;align-items:center}
  .btn{border:none;border-radius:6px;color:#fff;cursor:pointer;transition:opacity .15s}
  .btn:active{opacity:.7}
  .btn-back{width:3rem;height:3rem;background:#f44336}
  .btn-repeat{width:5.5rem;height:3rem;background:#2196f3}
  .btn-next{width:6rem;height:6rem;background:#4caf50;font-size:1.15rem}
  #status{position:fixed;left:0;right:0;bottom:0;background:#2e7d32;color:#fff;padding:.4rem .6rem;font-size:.9rem;display:none;z-index:9999}
  #status.err{background:#b71c1c} #status.warn{background:#ef6c00}
</style>
</head>
<body>
  <h1>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°</h1>
  <div class="container" id="container"></div>
  <div id="status"></div>

  <!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á -->
  <audio id="sound-next"   src="https://cdn.pixabay.com/audio/2022/03/15/audio_6e525c6022.mp3"></audio>
  <audio id="sound-repeat" src="https://cdn.pixabay.com/audio/2022/03/15/audio_d16f0b0c55.mp3"></audio>
  <audio id="sound-back"   src="https://cdn.pixabay.com/audio/2022/03/15/audio_f4a56382a7.mp3"></audio>

<script>
const configUrl = "https://script.google.com/macros/s/AKfycbwuuZPNLWIyMp2VrfYTp1t6W0SPjR8YrJ9t0XebthlKydEE6TwoW2n8Hm9IMBNlNmQQtQ/exec?action=config";
const queueApi  = "https://script.google.com/macros/s/AKfycbyjb1CUs-wS-muegVpyRUKicgFsrD4_gRC9Lx4CL8F4v0bIhL8P154V5Tfu_j4qILe4iw/exec";

const container = document.getElementById("container");
const statusBar = document.getElementById("status");
const soundNext   = document.getElementById("sound-next");
const soundRepeat = document.getElementById("sound-repeat");
const soundBack   = document.getElementById("sound-back");

function showStatus(msg, mode){ // ok|warn|err
  statusBar.textContent = msg;
  statusBar.className = mode || "";
  statusBar.style.display = "block";
  clearTimeout(showStatus._t);
  showStatus._t = setTimeout(()=> statusBar.style.display="none", 1600);
}
function playSound(a){ a.currentTime=0; a.play().catch(()=>{}); }
function flash(btn){ btn.style.opacity="0.6"; setTimeout(()=>btn.style.opacity="1",180); }

// ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô (called) ‡∏Ç‡∏≠‡∏á‡∏ó‡∏∏‡∏Å‡πÇ‡∏ï‡πä‡∏∞ ‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏õ‡πÅ‡∏õ‡∏∞‡∏ó‡∏µ‡πà label
async function refreshStatus() {
  try {
    const res = await fetch(`${queueApi}?action=status`, {cache:"no-store", credentials:"omit"});
    const map = await res.json(); // { "1": {queue:"A012", type:"A"}, ... }
    Object.keys(map).forEach(table=>{
      const q = document.getElementById(`queue-${table}`);
      if (q) q.textContent = map[table].queue || "-";
    });
  } catch(_) {}
}

fetch(configUrl, {cache:"no-store", credentials:"omit"})
  .then(r => r.json())
  .then(raw => {
    let entries = Array.isArray(raw)
      ? raw.map(x => ({ table:String(x.table), code:String(x.code||x.type), name:String(x.name||x.typename) }))
      : Object.entries(raw).map(([table,info]) => ({ table:String(table), code:String(info.code), name:String(info.name) }));
    entries.sort((a,b)=> Number(a.table)-Number(b.table));

    // ‡∏™‡∏£‡πâ‡∏≤‡∏á UI
    entries.forEach(conf => {
      const box = document.createElement("div");
      box.className = "table-box";
      box.innerHTML = `
        <div class="table-header">
          <span>‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}</span>
          <span>(${conf.code} - ${conf.name})</span>
        </div>
        <div class="queue-label" id="queue-${conf.table}">-</div>
        <div class="buttons">
          <button class="btn btn-back"   id="btn-back-${conf.table}">‚è™</button>
          <button class="btn btn-repeat" id="btn-repeat-${conf.table}">üîÅ</button>
          <button class="btn btn-next"   id="btn-next-${conf.table}">CALL</button>
        </div>`;
      container.appendChild(box);

      const qlbl     = document.getElementById(`queue-${conf.table}`);
      const btnBack   = document.getElementById(`btn-back-${conf.table}`);
      const btnRepeat = document.getElementById(`btn-repeat-${conf.table}`);
      const btnNext   = document.getElementById(`btn-next-${conf.table}`);

      // CALL ‚Üí action=next&table=#
      btnNext.onclick = async () => {
        flash(btnNext); playSound(soundNext);
        try{
          const url = `${queueApi}?action=next&table=${encodeURIComponent(conf.table)}`;
          const out = await (await fetch(url, {cache:"no-store", credentials:"omit"})).json();
          if(out.ok && out.queue){
            qlbl.textContent = out.queue;
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß ${out.queue}`, "ok");
            refreshStatus(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß
          }else if(out.empty){
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏¥‡∏ß‡∏£‡∏≠ (${out.type||"-"})`, "warn");
          }else{
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "err");
          }
        }catch(e){ showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: CALL ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î`, "err"); }
      };

      // REPEAT ‚Üí ‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á+‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
      btnRepeat.onclick = () => {
        flash(btnRepeat); playSound(soundRepeat);
        showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥`, "warn");
      };

      // BACK ‚Üí action=back&table=#
      btnBack.onclick = async () => {
        flash(btnBack); playSound(soundBack);
        try{
          const url = `${queueApi}?action=back&table=${encodeURIComponent(conf.table)}`;
          const out = await (await fetch(url, {cache:"no-store", credentials:"omit"})).json();
          if(out.ok){
            qlbl.textContent = out.queue || "-";
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡∏ñ‡∏≠‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí ${out.queue||"-"}`, "warn");
            refreshStatus();
          }else{
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡∏ñ‡∏≠‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "err");
          }
        }catch(e){ showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: BACK ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î`, "err"); }
      };
    });

    // ‡∏î‡∏∂‡∏á‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    refreshStatus();
    // (‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ã‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÉ‡∏´‡πâ‡πÉ‡∏Å‡∏•‡πâ realtime ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ô‡∏µ‡πâ)
    // setInterval(refreshStatus, 3000);
  })
  .catch(err => {
    showStatus("‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Web App/Sheet ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)", "err");
  });
</script>
</body>
</html>
