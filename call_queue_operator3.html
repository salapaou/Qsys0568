<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°</title>
<style>
  body{font-family:sans-serif;margin:0;background:#f5f5f5}
  h1{margin:.5rem 0;text-align:center;font-size:1.2rem}
  .container{display:flex;gap:.8rem;justify-content:center;flex-wrap:wrap;padding:.5rem}
  .table-box{border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.1);padding:.5rem;min-width:220px;display:flex;flex-direction:column;background:#fff}
  .table-header{display:flex;justify-content:space-between;font-weight:700}
  .queue-label{font-size:1.4rem;font-weight:700;text-align:center;margin:.4rem 0}
  .buttons{margin-top:auto;display:flex;gap:.5rem;justify-content:flex-end;align-items:center}
  .btn{border:none;border-radius:6px;color:#fff;cursor:pointer;transition:opacity .15s}
  .btn:active{opacity:.7}
  .btn-back{width:3rem;height:3rem;background:#f44336}
  .btn-repeat{width:5.5rem;height:3rem;background:#2196f3}
  .btn-next{width:6rem;height:6rem;background:#4caf50;font-size:1.15rem}
  /* ‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ï‡∏≤‡∏° type (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï‡∏≠‡∏¢‡∏≤‡∏Å‡πÅ‡∏¢‡∏Å‡∏™‡∏µ) */
  .type-a{background:#ffe5e5}.type-b{background:#e0f0ff}.type-c{background:#e8f5e9}
  .type-d{background:#fff3e0}.type-e{background:#f3e5f5}

  /* ‡πÅ‡∏ñ‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏•‡πà‡∏≤‡∏á‡∏à‡∏≠ */
  #status{position:fixed;left:0;right:0;bottom:0;background:#222;color:#fff;
    padding:.4rem .6rem;font-size:.9rem;display:none;z-index:9999}
  #status.ok{background:#2e7d32}
  #status.warn{background:#ef6c00}
  #status.err{background:#b71c1c}
</style>
</head>
<body>
  <h1>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°</h1>
  <div class="container" id="container"></div>
  <div id="status"></div>

  <!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á -->
  <audio id="sound-next"   src="https://cdn.pixabay.com/audio/2022/03/15/audio_6e525c6022.mp3"></audio>
  <audio id="sound-repeat" src="https://cdn.pixabay.com/audio/2022/03/15/audio_d16f0b0c55.mp3"></audio>
  <audio id="sound-back"   src="https://cdn.pixabay.com/audio/2022/03/15/audio_f4a56382a7.mp3"></audio>

<script>
/** 1) URL ‡∏Ç‡∏≠‡∏á API ‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏≠‡∏á‡∏ù‡∏±‡πà‡∏á **/
const configUrl = "https://script.google.com/macros/s/AKfycbwuuZPNLWIyMp2VrfYTp1t6W0SPjR8YrJ9t0XebthlKydEE6TwoW2n8Hm9IMBNlNmQQtQ/exec?action=config"; // ‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ï‡πä‡∏∞+‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
const queueApi  = "https://script.google.com/macros/s/AKfycbyjb1CUs-wS-muegVpyRUKicgFsrD4_gRC9Lx4CL8F4v0bIhL8P154V5Tfu_j4qILe4iw/exec";              // CALL ‡πÅ‡∏•‡∏∞ BACK (‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏´‡∏±‡∏™.gs)

const container   = document.getElementById("container");
const statusBar   = document.getElementById("status");
const soundNext   = document.getElementById("sound-next");
const soundRepeat = document.getElementById("sound-repeat");
const soundBack   = document.getElementById("sound-back");

function showStatus(msg, mode="ok"){ // mode: ok | warn | err
  statusBar.textContent = msg;
  statusBar.className = mode;
  statusBar.style.display = "block";
  clearTimeout(showStatus._t);
  showStatus._t = setTimeout(()=> statusBar.style.display="none", 1600);
}
function playSound(a){ a.currentTime=0; a.play().catch(()=>{}); }
function flash(btn){ btn.style.opacity="0.6"; setTimeout(()=>btn.style.opacity="1",180); }

/** 2) ‡πÇ‡∏´‡∏•‡∏î config ‡πÅ‡∏•‡πâ‡∏ß‡∏ß‡∏≤‡∏î‡∏Å‡∏•‡πà‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏à‡∏≤‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á */
fetch(configUrl, {cache:"no-store", credentials:"omit"})
  .then(r => { if(!r.ok) throw new Error("HTTP "+r.status); return r.json(); })
  .then(raw => {
    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á object {"1":{code,name},...} ‡πÅ‡∏•‡∏∞ array [{table,code/name},...]
    let entries = Array.isArray(raw)
      ? raw.map(x => ({ table:String(x.table), code:String(x.code||x.type), name:String(x.name||x.typename) }))
      : Object.entries(raw).map(([table,info]) => ({ table:String(table), code:String(info.code), name:String(info.name) }));

    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡πÇ‡∏ï‡πä‡∏∞
    entries.sort((a,b)=> Number(a.table)-Number(b.table));

    // ‡∏ß‡∏≤‡∏î UI
    entries.forEach(conf => {
      const box = document.createElement("div");
      box.className = "table-box"; // ‡∏à‡∏∞‡πÄ‡∏û‡∏¥‡πà‡∏° class type-a/b ‡πÑ‡∏î‡πâ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ map ‡∏™‡∏µ‡∏ï‡∏≤‡∏° code
      box.innerHTML = `
        <div class="table-header">
          <span>‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}</span>
          <span>(${conf.code} - ${conf.name})</span>
        </div>
        <div class="queue-label" id="queue-${conf.table}">-</div>
        <div class="buttons">
          <button class="btn btn-back"   id="btn-back-${conf.table}">‚è™</button>
          <button class="btn btn-repeat" id="btn-repeat-${conf.table}">üîÅ</button>
          <button class="btn btn-next"   id="btn-next-${conf.table}">CALL</button>
        </div>`;
      container.appendChild(box);

      const qlbl    = document.getElementById(`queue-${conf.table}`);
      const btnBack   = document.getElementById(`btn-back-${conf.table}`);
      const btnRepeat = document.getElementById(`btn-repeat-${conf.table}`);
      const btnNext   = document.getElementById(`btn-next-${conf.table}`);

      // CALL ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏à‡∏£‡∏¥‡∏á: ‡πÉ‡∏ä‡πâ queueApi ‡πÅ‡∏ö‡∏ö doGet (‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå type & name)
      btnNext.onclick = async () => {
        flash(btnNext); playSound(soundNext);
        try{
          const url = `${queueApi}?type=${encodeURIComponent(conf.code)}&name=${encodeURIComponent(conf.name)}`;
          const res = await fetch(url, {cache:"no-store", credentials:"omit"});
          const out = await res.json().catch(()=> ({}));
          if(out.queue){
            qlbl.textContent = out.queue;                 // ‡∏™‡∏°‡∏°‡∏ï‡∏¥‡∏ù‡∏±‡πà‡∏á GAS ‡∏™‡πà‡∏á queue ‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß ${out.queue}`, "ok");
          }else{
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "err");
          }
        }catch(e){
          showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î CALL`, "err");
        }
      };

      // REPEAT ‚Üí ‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á + ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)
      btnRepeat.onclick = () => {
        flash(btnRepeat); playSound(soundRepeat);
        showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥`, "warn");
      };

      // BACK ‚Üí ‡∏¢‡πâ‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏ß‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å called ‚Üí waiting
      btnBack.onclick = async () => {
        flash(btnBack); playSound(soundBack);
        try{
          const url = `${queueApi}?action=back&table=${encodeURIComponent(conf.table)}`;
          const res = await fetch(url, {cache:"no-store", credentials:"omit"});
          const out = await res.json().catch(()=> ({}));
          if(out.ok){
            qlbl.textContent = out.queue || "-";          // ‡πÄ‡∏ä‡πà‡∏ô A011
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡∏ñ‡∏≠‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí ${out.queue||"-"}`, "warn");
          }else{
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡∏ñ‡∏≠‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "err");
          }
        }catch(e){
          showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î BACK`, "err");
        }
      };
    });
    showStatus(`‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏ï‡πä‡∏∞‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${entries.length} ‡πÇ‡∏ï‡πä‡∏∞`, "ok");
  })
  .catch(err => {
    console.error(err);
    showStatus("‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå Web App/Sheet ‡πÅ‡∏•‡πâ‡∏ß‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä)", "err");
  });
</script>
</body>
</html>
