<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°</title>
<style>
  body{font-family:sans-serif;margin:0;background:#f5f5f5}
  h1{margin:.5rem 0;text-align:center}
  .container{display:flex;gap:1rem;justify-content:center;flex-wrap:wrap;padding:.5rem}
  .column{flex:1 1 320px;display:flex;flex-direction:column;gap:.5rem;min-width:320px;max-width:560px}
  .table-box{border-radius:10px;box-shadow:0 1px 4px rgba(0,0,0,.1);padding:.5rem;min-height:130px;display:flex;flex-direction:column}
  .table-header{display:flex;justify-content:space-between;align-items:center;font-weight:700}
  .table-label{background:#d32f2f;color:#fff;padding:.2rem .6rem;border-radius:6px}
  .type-label{background:#1976d2;color:#fff;padding:.2rem .6rem;border-radius:6px}
  .queue-label{font-size:1.3rem;margin:.4rem 0;text-align:center}
  .buttons{margin-top:auto;display:flex;gap:.5rem;justify-content:flex-end;align-items:center}
  .btn-back,.btn-repeat,.btn-next{border:none;border-radius:6px;color:#fff;cursor:pointer}
  .btn-back{width:3rem;height:3rem;background:#f44336}
  .btn-repeat{width:6rem;height:3rem;background:#87ceeb}
  .btn-next{width:6rem;height:6rem;background:#4caf50;font-size:1.2rem}
  .type-a{background:#ffe5e5}.type-b{background:#e0f0ff}.type-c{background:#e8f5e9}
  .type-d{background:#fff3e0}.type-e{background:#f3e5f5}

  /* ‡πÅ‡∏ú‡∏á‡πÅ‡∏à‡πâ‡∏á‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î */
  #status{position:fixed;left:0;right:0;bottom:0;background:#222;color:#fff;
    font-size:.9rem;padding:.4rem .6rem;display:none;z-index:9999}
  #status.error{background:#b71c1c}
</style>
</head>
<body>
  <h1>‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏£‡∏ß‡∏°</h1>
  <div class="container" id="container"></div>

  <!-- ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á -->
  <audio id="sound-next"   src="https://cdn.pixabay.com/audio/2022/03/15/audio_6e525c6022.mp3"></audio>
  <audio id="sound-repeat" src="https://cdn.pixabay.com/audio/2022/03/15/audio_d16f0b0c55.mp3"></audio>
  <audio id="sound-back"   src="https://cdn.pixabay.com/audio/2022/03/15/audio_f4a56382a7.mp3"></audio>

  <div id="status"></div>

<script>
const configUrl = "https://script.google.com/macros/s/AKfycbwuuZPNLWIyMp2VrfYTp1t6W0SPjR8YrJ9t0XebthlKydEE6TwoW2n8Hm9IMBNlNmQQtQ/exec?action=config";
// ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡∏°‡∏≤ ‚Äì ‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö CALL)
const callUrl   = "https://script.google.com/macros/s/AKfycbyjb1CUs-wS-muegVpyRUKicgFsrD4_gRC9Lx4CL8F4v0bIhL8P154V5Tfu_j4qILe4iw/exec";
// ‡∏¢‡πâ‡∏≠‡∏ô‡∏Ñ‡∏¥‡∏ß: ‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÅ‡∏ö‡∏ö ?action=back&table=#
const queueApi  = "https://script.google.com/macros/s/AKfycbyjb1CUs-wS-muegVpyRUKicgFsrD4_gRC9Lx4CL8F4v0bIhL8P154V5Tfu_j4qILe4iw/exec";

const container = document.getElementById("container");
const statusDiv = document.getElementById("status");

const soundNext   = document.getElementById("sound-next");
const soundRepeat = document.getElementById("sound-repeat");
const soundBack   = document.getElementById("sound-back");

function showStatus(msg, color="red") {
  statusDiv.style.color = color;
  statusDiv.innerText = msg;
  setTimeout(() => { statusDiv.innerText = ""; }, 2000);
}
function playSound(aud){ aud.currentTime = 0; aud.play().catch(()=>{}); }
function flash(btn){ btn.style.opacity="0.6"; setTimeout(()=>btn.style.opacity="1",180); }

fetch(configUrl)
  .then(res => res.json())
  .then(raw => {
    // ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏ó‡∏±‡πâ‡∏á object {"1":{code,name},...} ‡πÅ‡∏•‡∏∞ array
    const entries = (Array.isArray(raw) ? raw.map(x=>({
      table:String(x.table), code:String(x.code||x.type), name:String(x.name||x.typename)
    })) : Object.entries(raw).map(([table,info])=>({
      table:String(table), code:String(info.code), name:String(info.name)
    }))).sort((a,b)=>Number(a.table)-Number(b.table));

    entries.forEach(conf => {
      const box = document.createElement("div");
      box.className = "table-box";
      box.innerHTML = `
        <div class="table-header"><span>‡πÇ‡∏ï‡πä‡∏∞ ${conf.table} (${conf.code} - ${conf.name})</span></div>
        <div class="queue-label" id="queue-${conf.table}">-</div>
        <div class="buttons">
          <button class="btn btn-back"   id="btn-back-${conf.table}">‚è™</button>
          <button class="btn btn-repeat" id="btn-repeat-${conf.table}">üîÅ</button>
          <button class="btn btn-next"   id="btn-next-${conf.table}">CALL</button>
        </div>`;
      container.appendChild(box);

      const qlbl = document.getElementById(`queue-${conf.table}`);
      const bBack   = document.getElementById(`btn-back-${conf.table}`);
      const bRepeat = document.getElementById(`btn-repeat-${conf.table}`);
      const bNext   = document.getElementById(`btn-next-${conf.table}`);

      // CALL: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡∏≤‡∏° API add queue ‡πÄ‡∏î‡∏¥‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
      bNext.onclick = async () => {
        flash(bNext); playSound(soundNext);
        try {
          const url = `${callUrl}?type=${encodeURIComponent(conf.code)}&name=${encodeURIComponent(conf.name)}`;
          const res = await fetch(url, { cache:"no-store", credentials:"omit" });
          const out = await res.json().catch(()=> ({}));
          if (out.queue) {
            qlbl.textContent = out.queue;
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß ${out.queue}`, "green");
          } else {
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ñ‡∏¥‡∏ß‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "red");
          }
        } catch(err){
          showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î CALL`, "red");
        }
      };

      // REPEAT: ‡πÅ‡∏Ñ‡πà‡πÄ‡∏™‡∏µ‡∏¢‡∏á/feedback ‡πÉ‡∏´‡πâ ‡∏à‡∏ô‡∏ó.‡∏£‡∏π‡πâ‡∏ß‡πà‡∏≤‡∏Å‡∏î‡∏ï‡∏¥‡∏î
      bRepeat.onclick = () => {
        flash(bRepeat); playSound(soundRepeat);
        showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ã‡πâ‡∏≥`, "blue");
        // ‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏≠‡∏∞‡πÑ‡∏£‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
      };

      // BACK: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡πÉ‡∏´‡πâ‡∏¢‡πâ‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏Ç‡∏≠‡∏á‡πÇ‡∏ï‡πä‡∏∞‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å called -> waiting
      bBack.onclick = async () => {
        flash(bBack); playSound(soundBack);
        try {
          const url = `${queueApi}?action=back&table=${encodeURIComponent(conf.table)}`;
          const res = await fetch(url, { cache:"no-store", credentials:"omit" });
          const out = await res.json().catch(()=> ({}));
          // ‡πÉ‡∏´‡πâ‡∏ù‡∏±‡πà‡∏á GAS ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö {ok:true, queue:"A011", type:"A"} ‡∏´‡∏•‡∏±‡∏á‡∏ñ‡∏≠‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          if (out.ok) {
            qlbl.textContent = out.queue || "-";
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡∏ñ‡∏≠‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‚Üí ‡∏Ñ‡∏¥‡∏ß‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô ${out.queue||"-"}`, "orange");
          } else {
            showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡∏ñ‡∏≠‡∏¢‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`, "red");
          }
        } catch(err){
          showStatus(`‡πÇ‡∏ï‡πä‡∏∞ ${conf.table}: ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î BACK`, "red");
        }
      };
    });
  })
  .catch(err => {
    showStatus("‡πÇ‡∏´‡∏•‡∏î‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ", "red");
  });
</script>
</body>
</html>
